server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # -----------------------------------------------------------------------
    # Security Headers (mirrors .htaccess)
    # -----------------------------------------------------------------------
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Content-Type-Options    "nosniff" always;
    add_header X-Frame-Options           "DENY" always;
    add_header Referrer-Policy           "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy        "camera=(), microphone=(), geolocation=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=()" always;
    add_header Content-Security-Policy   "default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' https://csoh.org https://img.youtube.com https://i.ytimg.com data:; font-src 'self'; connect-src 'self'; frame-src https://www.youtube.com https://web.archive.org https://www.wired.com; frame-ancestors 'none'; base-uri 'self'; form-action 'self'; object-src 'none'" always;

    # Hide nginx version
    server_tokens off;

    # -----------------------------------------------------------------------
    # Custom error pages
    # -----------------------------------------------------------------------
    error_page 403 /403.html;
    error_page 404 /404.html;

    # -----------------------------------------------------------------------
    # Block sensitive files & directories
    # -----------------------------------------------------------------------

    # Block hidden files/dirs (.git, .env, .htaccess, etc.)
    location ~ /\. {
        deny all;
        return 403;
    }

    # Block scripts, markdown, config, and backup files
    location ~* \.(py|pyc|md|sh|bak|config|dist|fla|inc|ini|log|psd|sql|swp|swo)$ {
        deny all;
        return 403;
    }

    # Allow specific JSON files needed by site JS
    location = /preview-mapping.json {
        default_type application/json;
    }
    location = /resources-data.json {
        default_type application/json;
    }

    # Block all other JSON files
    location ~* \.json$ {
        deny all;
        return 403;
    }

    # Disable directory listing
    autoindex off;

    # -----------------------------------------------------------------------
    # Caching (mirrors .htaccess)
    # -----------------------------------------------------------------------

    # HTML — short cache
    location ~* \.html$ {
        expires 1h;
        add_header Cache-Control "public, must-revalidate";
    }

    # CSS & JS — long cache (cache-busted via ?v= param)
    location ~* \.(css|js)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Images — long cache
    location ~* \.(png|jpg|jpeg|gif|webp|svg|ico)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # XML files (sitemap, feed)
    location ~* \.xml$ {
        default_type application/xml;
    }

    # -----------------------------------------------------------------------
    # Redirect old /csoh/ paths to root
    # -----------------------------------------------------------------------
    location ^~ /csoh/ {
        rewrite ^/csoh/(.*)$ /$1 permanent;
    }
    location = /csoh {
        return 301 /;
    }

    # -----------------------------------------------------------------------
    # Default location
    # -----------------------------------------------------------------------
    location / {
        try_files $uri $uri/ =404;
    }
}
