name: Update News

on:
  schedule:
    - cron: '0 */3 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'update_news.py'

jobs:
  update-news:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: '3.x'

      - name: Update news.html from feeds
        run: python3 update_news.py

      - name: Detect changed files
        id: changes
        run: |
          set -euo pipefail
          files="$(git diff --name-only)"

          if [ -z "$files" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "only_news_files=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "has_changes=true" >> "$GITHUB_OUTPUT"

          count="$(printf '%s\n' "$files" | sed '/^$/d' | wc -l | tr -d ' ')"
          if [ "$count" = "1" ] && [ "$files" = "news.html" ]; then
            echo "only_news_files=true" >> "$GITHUB_OUTPUT"
          elif [ "$count" = "2" ] && printf '%s\n' "$files" | sort | grep -qx "feed.xml" && printf '%s\n' "$files" | sort | grep -qx "news.html"; then
            echo "only_news_files=true" >> "$GITHUB_OUTPUT"
          else
            echo "only_news_files=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Pull Request
        id: cpr
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@c5a7806660adbe173f04e3e038b0ccdcd758773c  # v6.1.0
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: 'chore: update news feed content'
          title: 'chore: Update news articles'
          body: |
            This PR was automatically created by the Update News workflow.

            The news feed content in `news.html` has been refreshed from configured RSS/Atom sources.

            **Changes:**
            - Updated article cards in `news.html`
            - Updated `dateModified` in JSON-LD

            This can be safely reviewed and merged.
          branch: update-news-content
          delete-branch: true
          labels: automated, content
          
      - name: Auto approve
        if: steps.cpr.outputs.pull-request-operation == 'created'
        run: gh pr review --approve "${{ steps.cpr.outputs.pull-request-number }}"
        env:
          GH_TOKEN: ${{ secrets.APPROVAL_PAT_TOKEN }}
          
      - name: Enable PR auto-merge when only news content files changed
        if: steps.changes.outputs.only_news_files == 'true' && steps.cpr.outputs.pull-request-number != ''
        uses: peter-evans/enable-pull-request-automerge@a660677d5469627102a1c1e11409dd063606628d  # v3.0.0
        with:
          token: ${{ secrets.PAT_TOKEN }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash
